<!DOCTYPE html> 
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	
		<link href="css/estilo.css" rel="stylesheet">

        <style>
            btn{
                cursor: pointer;
            }
        </style>
    </head>
    <body>

        <input type="text" class="namePersonagem"><btn class="btnPersonagem">Pesquisar personagem</btn>
        <input type="text" class="idPersonagem"><btn class="btnId">Pesquisar ID</btn>

        <div class="listPersonagens">
            <ul class="ulPersonagens">
            </ul>
        </div>

        <div class="msg"> </div>
        
        <script type="module">
            import { createFetch } from './js/createFetch.js';

            const valuePersonagemBtn = document.querySelector('.namePersonagem');
            const btnPersonagem = document.querySelector('.btnPersonagem');
            const valuePersonagemId = document.querySelector('.idPersonagem');
            const btnId = document.querySelector('.btnId');
            const $ulPersonagens = document.querySelector('.ulPersonagens');

            btnPersonagem.addEventListener('click', procuraPersonagem);

            function procuraPersonagem(){
                let personagemBuscado = valuePersonagemBtn.value;
                personagemBuscado = personagemBuscado.toLowerCase();
                
                if(personagemBuscado === ""){
                    alert("Digite um personagem");
                    return;
                }

                ajaxGet(personagemBuscado);
            }

            btnId.addEventListener('click', procuraPersonagemId);

            function procuraPersonagemId(){
                let personagemProcuradoId = valuePersonagemId.value;

                if(personagemProcuradoId === ""){
                    alert("Digite um ID");
                    return;
                }

                personagemProcuradoId = parseInt(personagemProcuradoId);

                ajaxGet(personagemProcuradoId)
            }


            function ajaxGet(personagem){
                // let xhr = new XMLHttpRequest();
                // let url = "http://localhost:3000/perguntas";
                // xhr.open("GET", url);
                // xhr.setRequestHeader("Content-type", "application/json;charset=UTF-8");
                // xhr.send(null);
                // xhr.onreadystatechange = verificaAjax;

                // function verificaAjax(){
                //     if(xhr.readyState === 4){
                //         if(xhr.status < 400){
                //             const json = JSON.parse(xhr.responseText);
                //             viewList(json);
                //         }else{
                //             alert("Deu ruim");
                //         }
                //     }
                // }

                createFetch("GET", "http://localhost:3000/perguntas")
                    .then(response => viewList(response));


                function removePersonagem(personagemm){
                    let btnRemovePersona = document.querySelector('.removePersona');
                    btnRemovePersona.addEventListener('click', function(){
                        createFetch("DELETE", `http://localhost:3000/perguntas/${personagemm}`)
                                    .then(respponse => console.log(respponse, deuCertoOuErrado("certo")))
                                valuePersonagemBtn.value = "";
                                valuePersonagemId.value = "";

                                const msg = document.querySelector('.msg');

                                function  deuCertoOuErrado(certoOuErrado){
                                    const msg = document.querySelector('.msg');

                                    if(certoOuErrado === "certo"){
                                        msg.classList.remove('none')
                                        msg.innerHTML = "Exclu√≠do com suceeso";
                                        msg.style.backgroundColor = "green";
                                        $ulPersonagens.innerHTML = "";

                                        setTimeout(function(){
                                            msg.classList.add('none');
                                        }, 2000)
                                    }

                                    if(certoOuErrado === "errado"){
                                        msg.classList.remove('none');
                                        msg.innerHTML = "Deu erro na hora do envio";
                                        msg.style.backgroundColor = "red";

                                        setTimeout(function(){
                                            msg.classList.add('none');
                                        }, 2000)

                                    }

                                
                                }
                    })
                    
                }

                let qtd = 0

                function viewList(information){
                    var x = 0;
                    while(x < information.length){
                        let arr = [];
                        let personagens = information[x].personagem;
                        personagens = personagens.toLowerCase();
                        if(personagens == personagem){
                                $ulPersonagens.innerHTML = `<li>${personagens}</li> <button class="removePersona">remove</button>`;

                                removePersonagem(information[x].id)
    

                                // $btnVoltarTela.classList.remove('none');

                                // $btnVoltarTela.addEventListener('click', function(){
                                //     $ulPersonagens.innerHTML = ""; 
                                //     ajaxGet();
                                //     $btnVoltarTela.classList.add('none');
                                // })
                                return;
                        }else{
                            qtd += 1;
                            console.log(information.length);
                            if(qtd == information.length){
                                console.log("Deu ruim")
                            }
                        }
                        x++;
                    }
                    
                }
            }


        </script>
    </body>
</html>