<!DOCTYPE html> 
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	
		<link href="css/estilo.css" rel="stylesheet">

        <style>
            btn{
                cursor: pointer;
            }
        </style>
    </head>
    <body>

        <input type="text" class="namePersonagem"><btn class="btnPersonagem">Pesquisar personagem</btn>
        <input type="text" class="idPersonagem"><btn class="btnId">Pesquisar ID</btn>

        <div class="listPersonagens">
            <ul class="ulPersonagens">
            </ul>
        </div>

        <div class="msg"> </div>
        
        <script type="module">
            import { createFetch } from './js/createFetch.js';

            const valuePersonagemBtn = document.querySelector('.namePersonagem');
            const btnPersonagem = document.querySelector('.btnPersonagem');
            const valuePersonagemId = document.querySelector('.idPersonagem');
            const btnId = document.querySelector('.btnId');
            const $ulPersonagens = document.querySelector('.ulPersonagens');


            function removePersonagem(personagemm){
                    let btnRemovePersona = document.querySelectorAll('.removePersona');
                    let z = 0;
                    while(z < btnRemovePersona.length){
                        btnRemovePersona[z].addEventListener('click', function(e){
                            console.log(e.target)
                            console.log(e.target.getAttribute("value"));
                        createFetch("DELETE", `http://localhost:3000/perguntas/${e.target.getAttribute("value")}`)
                                    .then(respponse => console.log(respponse, deuCertoOuErrado("certo")))
                                valuePersonagemBtn.value = "";
                                valuePersonagemId.value = "";

                                const msg = document.querySelector('.msg');

                                function  deuCertoOuErrado(certoOuErrado){
                                    const msg = document.querySelector('.msg');

                                    if(certoOuErrado === "certo"){
                                        msg.classList.remove('none')
                                        msg.innerHTML = "Excluído com suceeso";
                                        msg.style.backgroundColor = "green";
                                        $ulPersonagens.innerHTML = "";

                                        setTimeout(function(){
                                            msg.classList.add('none');
                                            carregaPersonagens();
                                        }, 2000)
                                    }

                                    if(certoOuErrado === "errado"){
                                        msg.classList.remove('none');
                                        msg.innerHTML = "Deu erro na hora do envio";
                                        msg.style.backgroundColor = "red";

                                        setTimeout(function(){
                                            msg.classList.add('none');
                                        }, 2000)

                                    }

                                
                                }
                    })
                        z++;
                    }
                    
                }

        function carregaPersonagens(){
            createFetch("GET", "http://localhost:3000/perguntas")
                .then(response => {
                    $ulPersonagens.innerHTML = "";
                    const l = response[0];
                    var x = 0;
                    while(x < response.length){
                        // const $li = document.createElement('li');
                        // let i = 0;
                        // i += x;
                        // let text = document.createTextNode(response[i].id + " " + response[x].personagem);
                        // $li.appendChild(text); 
                        // $ulPersonagens.appendChild($li);

                        $ulPersonagens.innerHTML += `<li>${response[x].personagem} ${response[x].id}</li> <button class="removePersona" value="${response[x].id}">remove</button>`;

                        removePersonagem(response[x].id);

                        x++;
                    }
                })
        }
            



            carregaPersonagens();





            btnPersonagem.addEventListener('click', procuraPersonagem);

            function procuraPersonagem(){
                let personagemBuscado = valuePersonagemBtn.value;
                personagemBuscado = personagemBuscado.toLowerCase();
                
                if(personagemBuscado === ""){
                    alert("Digite um personagem");
                    return;
                }

                ajaxGet(personagemBuscado);
            }

            btnId.addEventListener('click', procuraPersonagemId);

            function procuraPersonagemId(){
                let personagemProcuradoId = valuePersonagemId.value;

                if(personagemProcuradoId === ""){
                    alert("Digite um ID");
                    return;
                }

                personagemProcuradoId = parseInt(personagemProcuradoId);

                ajaxGet(personagemProcuradoId)
            }


            function ajaxGet(personagem){

                createFetch("GET", "http://localhost:3000/perguntas")
                    .then(response => viewList(response)); 

                let qtd = 0

                function viewList(information){
                    var x = 0;

                    $ulPersonagens.innerHTML = "";
                    valuePersonagemBtn.value = "";
                    valuePersonagemId.value = "";
                    while(x < information.length){

                        if(typeof personagem == 'number'){
                            let personagensId = information[x].id;
                            if(personagensId == personagem){
                                console.log("Chqgou aqui")
                                    $ulPersonagens.innerHTML += `<li>${information[x].personagem} ${information[x].id}</li> <button class="removePersona" value="${information[x].id}">remove</button>
                                    <br>
                                    <button class="voltarTela">Voltar todos os personagens</button>
                                    `;
                                    

                                    removePersonagem(information[x].id);

                                    let btnVoltarTelaId = document.querySelector('.voltarTela');

                                    btnVoltarTelaId.addEventListener('click', function(){
                                        carregaPersonagens();
                                    })


                                    // $btnVoltarTela.classList.remove('none');

                                    // $btnVoltarTela.addEventListener('click', function(){
                                    //     $ulPersonagens.innerHTML = ""; 
                                    //     ajaxGet();
                                    //     $btnVoltarTela.classList.add('none');
                                    // })
                            }else{
                                qtd += 1;
                                console.log(information.length);
                                if(qtd == information.length){
                                    alert("Personagem não encontrado");
                                    carregaPersonagens();
                                }
                            }
                        }else if(typeof personagem != 'number'){
                            let arr = [];
                            let personagens = information[x].personagem;
                            personagens = personagens.toLowerCase();
                            if(personagens == personagem){
                                    $ulPersonagens.innerHTML += `<li>${personagens} ${information[x].id}</li> <button class="removePersona" value="${information[x].id}">remove</button>
                                    <br>
                                    <button class="voltarTela">Voltar todos os personagens</button>
                                    `;

                                    removePersonagem(information[x].id)


                                    let btnVoltarTelaBtn = document.querySelector('.voltarTela');

                                    btnVoltarTelaBtn.addEventListener('click', function(){
                                        carregaPersonagens();
                                    })

                                    // $btnVoltarTela.classList.remove('none');

                                    // $btnVoltarTela.addEventListener('click', function(){
                                    //     $ulPersonagens.innerHTML = ""; 
                                    //     ajaxGet();
                                    //     $btnVoltarTela.classList.add('none');
                                    // })
                            }else{
                                qtd += 1;
                                console.log(information.length);
                                if(qtd == information.length){
                                    alert("Personagem não encontrado");
                                    carregaPersonagens();
                                }
                            }
                        }


                        x++;
                    }
                    
                }
            }


        </script>
    </body>
</html>